name: Deploy

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup SSH Access
              run: |
                mkdir -p ~/.ssh
                echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
                chmod 600 ~/.ssh/id_rsa
                ssh-keyscan -H ${{secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
            
            - name: Deploy to server instance
              run: |
                ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{secrets.SERVER_USER}}@${{ secrets.SERVER_HOST}} "git clone https://github.com/victor-ok/fastapi-book-project.git
                cd fastapi-book-project/script && chmod +x deploy.sh && sudo ./deploy.sh"

            - name: Clean Up SSH Key
              if: always()
              run: rm -f ~/.ssh/id_rsa
